# user root;
worker_processes auto;

error_log logs/error.log info;

events {
    worker_connections 10000;
}

http {
    # lua_code_cache off;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    lua_package_path "$prefix/conf/path/?.lua;;";
    lua_package_cpath "$prefix/conf/cpath/?.so;;";
    lua_shared_dict ssl 128m;
    lua_shared_dict ssl_lock 5m;
    lua_shared_dict domain 128m;
    lua_shared_dict domain_lock 5m;
    lua_shared_dict cache_lock 128m;
    
    init_by_lua_file conf/lua/init.lua;
    server {
        listen 80;
        listen 443 ssl http2; 
        # listenDynamic
        ssl_certificate certificate.crt;
        ssl_certificate_key private.key;
        ssl_certificate_by_lua_file conf/lua/ssl.lua;
        location /@cache {
            internal;
            set $cache_file "";
            access_by_lua_file conf/lua/access_cache.lua;
            alias $cache_file;
            header_filter_by_lua_file conf/lua/header_fileter_cache.lua;
            log_by_lua_file conf/lua/log_cache.lua;
        }
        location / {
            rewrite_by_lua_file conf/lua/rewrite_backend.lua;
            set $backend_url "";
            set $backend_host "";
            access_by_lua_file conf/lua/access_backend.lua;
            proxy_pass $backend_url;
            proxy_set_header HOST $backend_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $remote_addr;
            header_filter_by_lua_file conf/lua/header_fileter_backend.lua;
            body_filter_by_lua_file conf/lua/body_fileter_backend.lua;
            log_by_lua_file conf/lua/log_backend.lua;
        }
    }
}